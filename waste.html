<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FoodIQ ‚Äî Canteen Analytics</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      /* FoodIQ Signature Theme */
      --primary: #FF6B00;
      --primary-hover: #e65e00;
      --emerald: #10B981;
      --emerald-light: #ecfdf5;
      --bg: #FFF5EC;
      --card-bg: #ffffff;
      --text-main: #111827;
      --text-muted: #9CA3AF;
      --border: #F3F4F6;
      --radius: 16px;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
      --shadow-md: 0 10px 30px -10px rgba(255, 107, 0, 0.1);
    }

    * { box-sizing: border-box; outline: none; }
    
    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg);
      color: var(--text-main);
      margin: 0;
      padding: 0;
      line-height: 1.5;
    }

    /* Layout Structure */
    .container {
      max-width: 1280px;
      margin: 0 auto;
      padding: 24px;
    }

    /* --- UPDATED HEADER STYLES --- */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
      background: var(--card-bg);
      padding: 16px 24px;
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border);
    }

    /* Container for Logo + Button */
    .header-left-group {
      display: flex;
      align-items: center;
      gap: 32px; /* Spacing between Logo and Surplus Button */
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .brand-icon {
      width: 40px;
      height: 40px;
      background: var(--primary);
      color: white;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: bold;
      box-shadow: 0 4px 10px rgba(255,107,0,0.3);
    }

    .brand-text h1 {
      font-family: 'Poppins', sans-serif;
      font-size: 20px;
      margin: 0;
      font-weight: 700;
      color: var(--text-main);
      line-height: 1.2;
    }

    .brand-text span {
      font-size: 13px;
      color: var(--text-muted);
      font-weight: 500;
    }

    /* --- NEW SURPLUS BUTTON STYLE --- */
    .surplus-btn {
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      background-color: #fff;
      
      /* The requested Green Highlights */
      border: 1px solid var(--border);
      border-left: 4px solid var(--emerald); 
      color: var(--emerald);
      
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.2s ease;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    .surplus-btn:hover {
      background-color: var(--emerald-light);
      transform: translateY(-1px);
      box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.1);
    }

    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    /* KPI Grid */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .kpi-card {
      background: var(--card-bg);
      padding: 24px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      position: relative;
      overflow: hidden;
    }
    
    .kpi-card::after {
        content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 3px; background: var(--border);
    }
    .kpi-card:hover { transform: translateY(-2px); transition: 0.2s; border-color: var(--primary); }

    .kpi-label { font-size: 11px; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; }
    .kpi-value { font-size: 32px; font-weight: 700; color: var(--text-main); margin-top: 8px; font-family: 'Inter', sans-serif; letter-spacing: -1px; }

    /* Main Grid */
    .dashboard-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 24px;
    }

    .card {
      background: var(--card-bg);
      padding: 24px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .card-title { font-family: 'Poppins', sans-serif; font-size: 16px; font-weight: 600; color: var(--text-main); }
    .card-subtitle { font-size: 13px; color: var(--text-muted); }

    /* Controls & Inputs */
    input[type="date"], input[type="number"] {
      padding: 10px 14px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-family: inherit;
      font-size: 14px;
      color: var(--text-main);
      background: #f9fafb;
      transition: all 0.2s;
    }
    input:focus { border-color: var(--primary); background: #fff; box-shadow: 0 0 0 3px rgba(255, 107, 0, 0.1); }

    button.btn {
      padding: 10px 18px;
      border-radius: 10px;
      border: 1px solid transparent;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    /* Primary: Solid Orange */
    .btn-primary { 
      background: var(--primary); 
      color: white; 
      box-shadow: 0 2px 4px rgba(255,122,32,0.2); 
    }
    .btn-primary:hover { 
      background: var(--primary-hover); 
      transform: translateY(-1px); 
    }
    
    /* Outline Primary: White BG, Orange Text/Border */
    .btn-outline-primary {
      background: white;
      border-color: var(--primary);
      color: var(--primary);
    }
    .btn-outline-primary:hover {
      background: #fff7ed; /* Light orange tint */
      color: var(--primary-hover);
      border-color: var(--primary-hover);
    }
    
    .btn-secondary { background: white; border-color: var(--border); color: var(--text-main); }
    .btn-secondary:hover { background: #f9fafb; border-color: #d1d5db; color: var(--primary); }
    
    .btn-success { background: #10b981; color: white; }
    .btn-success:hover { background: #059669; }

    /* Tables & Lists */
    .table-container {
      overflow-y: auto;
      max-height: 400px;
      border: 1px solid var(--border);
      border-radius: 12px;
    }

    .data-row {
      display: flex;
      justify-content: space-between;
      padding: 14px 20px;
      border-bottom: 1px solid var(--border);
      background: white;
      transition: background 0.15s;
      cursor: pointer;
    }
    .data-row:last-child { border-bottom: none; }
    .data-row:hover { background: #fff7ed; }
    .data-date { font-weight: 600; font-size: 14px; color: var(--text-main); }
    .data-meta { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
    .data-value { font-weight: 700; font-size: 15px; color: var(--primary); text-align: right; }
    .data-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; font-weight: 600; }

    /* Helpers */
    .controls-row { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
    .helper-text { font-size: 13px; color: var(--text-muted); line-height: 1.4; }
    .mt-4 { margin-top: 16px; }

    /* Responsive */
    @media (max-width: 1024px) {
      .dashboard-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <div class="container">
    
    <header class="header">
      
      <div class="header-left-group">
        <div class="brand">
          <div class="brand-icon">üçΩ</div>
          <div class="brand-text">
            <h1>FoodIQ</h1>
            <span>Canteen Analytics Dashboard</span>
          </div>
        </div>

        <a href="thershold.html" class="surplus-btn">
          <span>Surplus Meter</span>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"></path><path d="m12 5 7 7-7 7"></path></svg>
        </a>
      </div>

      <div class="header-actions">
        <span class="helper-text" id="yearBox">2023</span>
        <button class="btn btn-secondary" id="refreshBtn">
          <span style="margin-right:4px">‚Üª</span> Refresh Data
        </button>
      </div>

    </header>

    <div class="kpi-grid" id="kpiArea">
      <div class="kpi-card" style="border-bottom: 4px solid #3B82F6;">
        <div class="kpi-label">Total Prepared</div>
        <div class="kpi-value" id="prepared">--</div>
      </div>
      <div class="kpi-card" style="border-bottom: 4px solid var(--emerald);">
        <div class="kpi-label">Total Consumed</div>
        <div class="kpi-value" id="consumed">--</div>
      </div>
      <div class="kpi-card" style="border-bottom: 4px solid var(--primary);">
        <div class="kpi-label">Total Surplus</div>
        <div class="kpi-value" id="surplus" style="color: var(--primary);">--</div>
      </div>
      <div class="kpi-card" style="border-bottom: 4px solid #F59E0B;">
        <div class="kpi-label">Avg. Consumption Rate</div>
        <div class="kpi-value" id="consrate">--%</div>
      </div>
    </div>

    <div class="dashboard-grid">
      
      <div style="display: flex; flex-direction: column; gap: 24px;">
        
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Daily Surplus Trend</div>
              <div class="card-subtitle">Values in Kilograms (kg)</div>
            </div>
          </div>
          <div style="position: relative; height: 300px; width: 100%;">
            <canvas id="dailyChart"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Top Wasted Dishes</div>
              <div class="card-subtitle">Highest volume of waste by item</div>
            </div>
          </div>
          <div style="position: relative; height: 260px; width: 100%;">
            <canvas id="dishChart"></canvas>
          </div>
        </div>
      </div>

      <div style="display: flex; flex-direction: column; gap: 24px;">
        
        <div class="card" style="height: auto;">
          <div class="card-header">
            <div class="card-title">Analysis Tools</div>
          </div>

          <div style="margin-bottom: 24px;">
            <div class="kpi-label" style="margin-bottom: 8px;">Threshold Check</div>
            <div class="controls-row">
              <input id="thresholdDate" type="date" style="flex:1" />
              <input id="thresholdQty" type="number" placeholder="Qty" style="width: 80px;" />
              <button class="btn btn-primary" id="checkBtn">Check</button>
            </div>
            <div id="thresholdResult" class="helper-text" style="background:#f9fafb; padding:10px; border-radius:8px; border:1px dashed var(--border);">
              Select a date and quantity to find high-waste items.
            </div>
          </div>

          <div>
            <div class="kpi-label" style="margin-bottom: 8px;">Quick Actions</div>
            <div class="controls-row">
              <button class="btn btn-primary" id="predBtn" style="flex:1;">Show Predictions</button>
              <button class="btn btn-outline-primary" id="exportBtn" style="flex:1;">Export CSV</button>
            </div>
          </div>
        </div>

        <div class="card" style="flex: 1; min-height: 400px;">
          <div class="card-header">
            <div>
              <div class="card-title">Detailed Logs</div>
              <div class="card-subtitle">Click row to inspect details</div>
            </div>
          </div>
          <div id="tableWrap" class="table-container">
            <div style="padding: 20px; text-align: center; color: var(--text-muted);">Loading data...</div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    // --- Chart Defaults ---
    Chart.defaults.font.family = "'Inter', sans-serif";
    Chart.defaults.color = '#9CA3AF';
    document.getElementById("yearBox").innerText = new Date().getFullYear();

    let dailyChartInstance, dishChartInstance;

    // --- DATA GENERATOR (Context Aware) ---
    function generateWastageData() {
        // Business Context: ~2500 meals/week
        // Waste Rate: ~5-8% (Efficient)
        
        const dishes = [
            { name: "Steamed Rice", waste_factor: 5.5 }, // High volume = high waste kg
            { name: "Dal Tadka", waste_factor: 4.2 },
            { name: "Chicken Biryani", waste_factor: 1.5 }, // High demand = low waste
            { name: "Vada Pav", waste_factor: 2.8 }, // Perishable
            { name: "Veg Sabzi", waste_factor: 3.5 },
            { name: "Samosa", waste_factor: 3.0 },
            { name: "Roti/Chapati", waste_factor: 2.2 }
        ];

        // 1. Overall Stats
        const totalPrepared = 12500 + Math.floor(Math.random() * 500);
        const wasteRate = 0.06 + (Math.random() * 0.02); // 6-8%
        const totalSurplus = Math.floor(totalPrepared * wasteRate);
        const totalConsumed = totalPrepared - totalSurplus;

        // 2. Daily Trend (Last 7 Days)
        const days = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
        const dailyData = days.map(day => {
            const prep = 400 + Math.floor(Math.random() * 100); // kg
            const surp = Math.floor(prep * (0.05 + Math.random() * 0.05));
            return {
                date: day,
                quantity_prepared: prep + " kg",
                quantity_consumed: (prep - surp) + " kg",
                surplus: surp + " kg",
                surplus_raw: surp // for chart
            };
        });

        // 3. Top Dishes Data
        const topDishes = dishes.map(d => ({
            dish_name: d.name,
            waste_volume: (d.waste_factor + Math.random()).toFixed(1) // kg avg per day
        })).sort((a,b) => b.waste_volume - a.waste_volume);

        return {
            overall: {
                total_prepared: totalPrepared.toLocaleString() + " kg",
                total_consumed: totalConsumed.toLocaleString() + " kg",
                total_surplus: totalSurplus.toLocaleString() + " kg",
                avg_consumption_rate_percent: ((1 - wasteRate) * 100).toFixed(1)
            },
            daily: dailyData,
            dishes: topDishes
        };
    }

    // --- RENDERERS ---

    function renderOverview(o){
      document.getElementById("prepared").innerText = o.total_prepared;
      document.getElementById("consumed").innerText = o.total_consumed;
      document.getElementById("surplus").innerText = o.total_surplus;
      document.getElementById("consrate").innerText = o.avg_consumption_rate_percent + "%";
    }

    function drawDailyChart(data){
      const ctx = document.getElementById("dailyChart").getContext("2d");
      
      // Gradient Fill
      const gradient = ctx.createLinearGradient(0, 0, 0, 300);
      gradient.addColorStop(0, 'rgba(255, 107, 0, 0.2)');
      gradient.addColorStop(1, 'rgba(255, 107, 0, 0.0)');

      if(dailyChartInstance) dailyChartInstance.destroy();
      
      dailyChartInstance = new Chart(ctx, {
        type: "line",
        data: { 
          labels: data.map(r => r.date), 
          datasets:[{ 
            label: "Surplus (kg)", 
            data: data.map(r => r.surplus_raw), 
            borderColor: '#FF6B00', 
            backgroundColor: gradient, 
            borderWidth: 3,
            pointBackgroundColor: "#ffffff",
            pointBorderColor: "#FF6B00",
            pointBorderWidth: 2,
            pointRadius: 5,
            pointHoverRadius: 7,
            fill: true, 
            tension: 0.4 
          }]
        },
        options: { 
          responsive: true, 
          maintainAspectRatio: false,
          plugins: { legend: { display: false } }, 
          scales: { 
            y: { beginAtZero: true, grid: { borderDash: [5, 5], color: '#f3f4f6' } },
            x: { grid: { display: false } }
          } 
        }
      });
    }

    function drawDishChart(dishes){
      const ctx = document.getElementById("dishChart").getContext("2d");
      if(dishChartInstance) dishChartInstance.destroy();
      
      dishChartInstance = new Chart(ctx, {
        type: "bar",
        data: { 
          labels: dishes.map(d => d.dish_name), 
          datasets:[{ 
            label: "Avg Waste (kg/day)", 
            data: dishes.map(d => d.waste_volume), 
            backgroundColor: '#FF6B00',
            borderRadius: 6,
            barThickness: 24
          }]
        },
        options: { 
          indexAxis: 'y', 
          responsive: true, 
          maintainAspectRatio: false,
          plugins: { legend: { display: false } }, 
          scales: { 
            x: { beginAtZero: true, grid: { borderDash: [5, 5], color: '#f3f4f6' } },
            y: { grid: { display: false } }
          } 
        }
      });
    }

    function renderDailyTable(daily){
      const wrap = document.getElementById("tableWrap");
      wrap.innerHTML = "";
      
      const rows =