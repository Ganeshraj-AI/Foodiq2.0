<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FoodIQ ‚Äî Canteen Analytics</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      /* FoodIQ Signature Theme */
      --primary: #ff7a20;
      --primary-hover: #e56000;
      --bg: #f3f4f6;
      --card-bg: #ffffff;
      --text-main: #111827;
      --text-muted: #6b7280;
      --border: #e5e7eb;
      --radius: 12px;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      
      --emerald: #10b981;
      --emerald-light: #ecfdf5;
    }

    * { box-sizing: border-box; outline: none; }
    
    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg);
      color: var(--text-main);
      margin: 0;
      padding: 0;
      line-height: 1.5;
    }

    /* Layout Structure */
    .container {
      max-width: 1280px;
      margin: 0 auto;
      padding: 24px;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
      background: var(--card-bg);
      padding: 16px 24px;
      border-radius: 16px;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border);
    }

    .header-left-group { display: flex; align-items: center; gap: 32px; }

    .brand { display: flex; align-items: center; gap: 12px; }
    .brand-icon {
      width: 40px; height: 40px; background: var(--primary); color: white;
      border-radius: 10px; display: flex; align-items: center; justify-content: center;
      font-size: 20px; font-weight: bold;
    }
    .brand-text h1 { font-family: 'Poppins', sans-serif; font-size: 20px; margin: 0; font-weight: 700; color: var(--text-main); }
    .brand-text span { font-size: 13px; color: var(--text-muted); font-weight: 500; }

    .surplus-btn {
      text-decoration: none; display: inline-flex; align-items: center; gap: 8px;
      padding: 10px 20px; background-color: #fff;
      border: 1px solid var(--border); border-left: 4px solid var(--emerald); 
      color: var(--emerald); border-radius: 8px; font-weight: 600; font-size: 14px;
      transition: all 0.2s ease; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .surplus-btn:hover { background-color: var(--emerald-light); transform: translateY(-1px); box-shadow: var(--shadow-md); }

    .header-actions { display: flex; gap: 12px; align-items: center; }

    /* KPI Grid */
    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 24px; }
    .kpi-card {
      background: var(--card-bg); padding: 20px; border-radius: var(--radius);
      border: 1px solid var(--border); box-shadow: var(--shadow-sm);
      display: flex; flex-direction: column; justify-content: space-between;
    }
    .kpi-label { font-size: 13px; color: var(--text-muted); font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
    .kpi-value { font-size: 28px; font-weight: 700; color: var(--text-main); margin-top: 8px; font-family: 'Poppins', sans-serif; }

    /* Main Grid */
    .dashboard-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; }
    .card {
      background: var(--card-bg); padding: 24px; border-radius: var(--radius);
      border: 1px solid var(--border); box-shadow: var(--shadow-sm);
      height: 100%; display: flex; flex-direction: column;
    }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .card-title { font-family: 'Poppins', sans-serif; font-size: 16px; font-weight: 600; color: var(--text-main); }
    .card-subtitle { font-size: 13px; color: var(--text-muted); }

    /* Inputs & Buttons */
    input[type="date"], input[type="number"] {
      padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px;
      font-family: inherit; font-size: 14px; color: var(--text-main); background: #f9fafb; transition: all 0.2s;
    }
    input:focus { border-color: var(--primary); background: #fff; }

    button.btn {
      padding: 9px 16px; border-radius: 8px; border: 1px solid transparent;
      font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s;
    }
    .btn-primary { background: var(--primary); color: white; box-shadow: 0 2px 4px rgba(255,122,32,0.2); }
    .btn-primary:hover { background: var(--primary-hover); transform: translateY(-1px); }
    .btn-outline-primary { background: white; border-color: var(--primary); color: var(--primary); }
    .btn-outline-primary:hover { background: #fff7ed; }
    .btn-secondary { background: white; border-color: var(--border); color: var(--text-main); }
    .btn-secondary:hover { background: #f9fafb; border-color: #d1d5db; }

    /* Table */
    .table-container { overflow-y: auto; max-height: 400px; border: 1px solid var(--border); border-radius: 8px; }
    .data-row {
      display: flex; justify-content: space-between; padding: 12px 16px;
      border-bottom: 1px solid var(--border); background: white; transition: background 0.15s; cursor: pointer;
    }
    .data-row:last-child { border-bottom: none; }
    .data-row:hover { background: #fff7ed; }
    .data-date { font-weight: 600; font-size: 14px; }
    .data-meta { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
    .data-value { font-weight: 700; font-size: 15px; color: var(--primary); text-align: right; }
    .data-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; }

    .controls-row { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
    .helper-text { font-size: 13px; color: var(--text-muted); line-height: 1.4; }

    @media (max-width: 1024px) { .dashboard-grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>

  <div class="container">
    
    <header class="header">
      <div class="header-left-group">
        <div class="brand">
          <div class="brand-icon">üçΩ</div>
          <div class="brand-text">
            <h1>FoodIQ</h1>
            <span>Canteen Analytics Dashboard</span>
          </div>
        </div>
        <a href="thershold.html" class="surplus-btn">
          <span>NGO MAPPING</span>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"></path><path d="m12 5 7 7-7 7"></path></svg>
        </a>
      </div>
      <div class="header-actions">
        <span class="helper-text" id="yearBox">2023</span>
        <button class="btn btn-secondary" id="refreshBtn">
          <span style="margin-right:4px">‚Üª</span> Refresh Data
        </button>
      </div>
    </header>

    <div class="kpi-grid" id="kpiArea">
      <div class="kpi-card" style="border-bottom: 4px solid #3B82F6;">
        <div class="kpi-label">Total Prepared</div>
        <div class="kpi-value" id="prepared">--</div>
      </div>
      <div class="kpi-card" style="border-bottom: 4px solid var(--emerald);">
        <div class="kpi-label">Total Consumed</div>
        <div class="kpi-value" id="consumed">--</div>
      </div>
      <div class="kpi-card" style="border-bottom: 4px solid var(--primary);">
        <div class="kpi-label">Total Surplus</div>
        <div class="kpi-value" id="surplus" style="color: var(--primary);">--</div>
      </div>
      <div class="kpi-card" style="border-bottom: 4px solid #F59E0B;">
        <div class="kpi-label">Avg. Consumption Rate</div>
        <div class="kpi-value" id="consrate">--%</div>
      </div>
    </div>

    <div class="dashboard-grid">
      
      <div style="display: flex; flex-direction: column; gap: 24px;">
        
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Daily Surplus Trend</div>
              <div class="card-subtitle">Values in Kilograms (kg)</div>
            </div>
          </div>
          <div style="position: relative; height: 300px; width: 100%;">
            <canvas id="dailyChart"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Top Wasted Dishes</div>
              <div class="card-subtitle">Highest volume of waste by item</div>
            </div>
          </div>
          <div style="position: relative; height: 260px; width: 100%;">
            <canvas id="dishChart"></canvas>
          </div>
        </div>
      </div>

      <div style="display: flex; flex-direction: column; gap: 24px;">
        
        <div class="card" style="height: auto;">
          <div class="card-header">
            <div class="card-title">Analysis Tools</div>
          </div>

          <div style="margin-bottom: 24px;">
            <div class="kpi-label" style="margin-bottom: 8px;">Threshold Check</div>
            <div class="controls-row">
              <input id="thresholdDate" type="date" style="flex:1" />
              <input id="thresholdQty" type="number" placeholder="Qty" style="width: 80px;" />
              <button class="btn btn-primary" id="checkBtn">Check</button>
            </div>
            <div id="thresholdResult" class="helper-text" style="background:#f9fafb; padding:10px; border-radius:8px; border:1px dashed var(--border);">
              Select a date and quantity to find high-waste items.
            </div>
          </div>

          <div>
            <div class="kpi-label" style="margin-bottom: 8px;">Quick Actions</div>
            <div class="controls-row">
              <button class="btn btn-primary" id="predBtn" style="flex:1;">Show Predictions</button>
              <button class="btn btn-outline-primary" id="exportBtn" style="flex:1;">Export CSV</button>
            </div>
          </div>
        </div>

        <div class="card" style="flex: 1; min-height: 400px;">
          <div class="card-header">
            <div>
              <div class="card-title">Detailed Logs</div>
              <div class="card-subtitle">Click row to inspect details</div>
            </div>
          </div>
          <div id="tableWrap" class="table-container">
            <div style="padding: 20px; text-align: center; color: var(--text-muted);">Loading data...</div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    // --- Chart Defaults ---
    Chart.defaults.font.family = "'Inter', sans-serif";
    Chart.defaults.color = '#6b7280';
    document.getElementById("yearBox").innerText = new Date().getFullYear();

    let dailyChartInstance, dishChartInstance;

    // --- CONTEXT-AWARE DATA GENERATOR ---
    function generateWastageData() {
        // Since Lunch is the main revenue driver, it likely has the highest absolute waste volume.
        // Vada Pav is high margin but perishable.
        
        const dishes = [
            { name: "Steamed Rice", waste_factor: 5.5 }, // High volume staple
            { name: "Dal Tadka", waste_factor: 4.2 },
            { name: "Chicken Biryani", waste_factor: 1.5 }, // High value, kept careful
            { name: "Vada Pav", waste_factor: 2.8 }, // Perishable snack
            { name: "Veg Sabzi", waste_factor: 3.5 },
            { name: "Samosa", waste_factor: 3.0 },
            { name: "Roti/Chapati", waste_factor: 2.2 }
        ];

        // 1. Overall Stats
        const totalPrepared = 12500 + Math.floor(Math.random() * 500); // kg
        const wasteRate = 0.06 + (Math.random() * 0.02); // 6-8%
        const totalSurplus = Math.floor(totalPrepared * wasteRate);
        const totalConsumed = totalPrepared - totalSurplus;

        // 2. Daily Trend (Last 7 Days)
        const days = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
        const dailyData = days.map(day => {
            const prep = 400 + Math.floor(Math.random() * 100);
            const surp = Math.floor(prep * (0.05 + Math.random() * 0.05));
            return {
                date: day,
                quantity_prepared: prep + " kg",
                quantity_consumed: (prep - surp) + " kg",
                surplus: surp + " kg",
                surplus_raw: surp
            };
        });

        // 3. Top Dishes Data
        const topDishes = dishes.map(d => ({
            dish_name: d.name,
            waste_rate_percent: (d.waste_factor + Math.random()).toFixed(1)
        })).sort((a,b) => b.waste_rate_percent - a.waste_rate_percent);

        return {
            overall: {
                total_prepared: totalPrepared.toLocaleString() + " kg",
                total_consumed: totalConsumed.toLocaleString() + " kg",
                total_surplus: totalSurplus.toLocaleString() + " kg",
                avg_consumption_rate_percent: ((1 - wasteRate) * 100).toFixed(1)
            },
            daily: dailyData,
            dishes: topDishes
        };
    }

    // --- RENDERERS ---

    function renderOverview(o){
      document.getElementById("prepared").innerText = o.total_prepared;
      document.getElementById("consumed").innerText = o.total_consumed;
      document.getElementById("surplus").innerText = o.total_surplus;
      document.getElementById("consrate").innerText = o.avg_consumption_rate_percent + "%";
    }

    function drawDailyChart(data){
      const ctx = document.getElementById("dailyChart").getContext("2d");
      
      // Gradient Fill
      const gradient = ctx.createLinearGradient(0, 0, 0, 300);
      gradient.addColorStop(0, 'rgba(255, 122, 32, 0.2)');
      gradient.addColorStop(1, 'rgba(255, 122, 32, 0.0)');

      if(dailyChartInstance) dailyChartInstance.destroy();
      
      dailyChartInstance = new Chart(ctx, {
        type: "line",
        data: { 
          labels: data.map(r => r.date), 
          datasets:[{ 
            label: "Surplus (kg)", 
            data: data.map(r => r.surplus_raw), 
            borderColor: '#ff7a20', 
            backgroundColor: gradient, 
            borderWidth: 3,
            pointBackgroundColor: "#ffffff",
            pointBorderColor: "#ff7a20",
            pointBorderWidth: 2,
            pointRadius: 5,
            pointHoverRadius: 7,
            fill: true, 
            tension: 0.4 
          }]
        },
        options: { 
          responsive: true, 
          maintainAspectRatio: false,
          plugins: { legend: { display: false } }, 
          scales: { 
            y: { beginAtZero: true, grid: { borderDash: [5, 5], color: '#f3f4f6' } },
            x: { grid: { display: false } }
          } 
        }
      });
    }

    function drawDishChart(dishes){
      const ctx = document.getElementById("dishChart").getContext("2d");
      
      if(dishChartInstance) dishChartInstance.destroy();
      
      dishChartInstance = new Chart(ctx, {
        type: "bar",
        data: { 
          labels: dishes.map(d => d.dish_name), 
          datasets:[{ 
            label: "Avg Waste (kg/day)", 
            data: dishes.map(d => d.waste_rate_percent), 
            backgroundColor: '#ff7a20',
            borderRadius: 6,
            barThickness: 24
          }]
        },
        options: { 
          indexAxis: 'y', 
          responsive: true, 
          maintainAspectRatio: false,
          plugins: { legend: { display: false } }, 
          scales: { 
            x: { beginAtZero: true, grid: { borderDash: [5, 5], color: '#f3f4f6' } },
            y: { grid: { display: false } }
          } 
        }
      });
    }

    function renderDailyTable(daily){
      const wrap = document.getElementById("tableWrap");
      wrap.innerHTML = "";
      
      const rows = daily.map(r => `
        <div class="data-row" onclick="rowClick('${r.date}')">
          <div>
            <div class="data-date">${r.date}</div>
            <div class="data-meta">Prep: ${r.quantity_prepared} ¬∑ Consumed: ${r.quantity_consumed}</div>
          </div>
          <div>
            <div class="data-value">${r.surplus}</div>
            <div class="data-label">Surplus</div>
          </div>
        </div>
      `).join("");
      
      wrap.innerHTML = rows;
    }

    // --- INTERACTION LOGIC ---

    window.rowClick = function(date){
      // Simulate detail view logic based on data context
      const details = [
          "‚Ä¢ Rice: 5kg surplus",
          "‚Ä¢ Dal: 3kg surplus",
          "‚Ä¢ Roti: 12 units left"
      ].join("\n");
      alert(`Waste Breakdown for ${date}:\n\n${details}`);
    };

    async function loadAndRender(){
      const btn = document.getElementById("refreshBtn");
      btn.innerHTML = "‚åõ Loading...";
      
      // Simulate Latency
      await new Promise(r => setTimeout(r, 600));
      
      const data = generateWastageData();
      
      renderOverview(data.overall);
      drawDailyChart(data.daily);
      drawDishChart(data.dishes);
      renderDailyTable(data.daily);
      
      btn.innerHTML = '<span style="margin-right:4px">‚Üª</span> Refresh Data';
    }

    // Threshold Checker Logic
    document.getElementById("checkBtn").addEventListener("click", () => {
      const date = document.getElementById("thresholdDate").value;
      const qty = document.getElementById("thresholdQty").value;
      const res = document.getElementById("thresholdResult");
      
      if(!date || !qty) {
          res.innerHTML = `<span style="color:#ef4444">Please select date & quantity.</span>`;
          return;
      }
      
      // Simulated Logic: Random check
      const isHigh = Math.random() > 0.5;
      if(isHigh) {
          res.innerHTML = `<span style="color:#ef4444"><b>Alert:</b> 3 items exceeded ${qty}kg on this date.</span>`;
      } else {
          res.innerHTML = `<span style="color:#10b981"><b>Good:</b> No items exceeded ${qty}kg.</span>`;
      }
    });

    document.getElementById("refreshBtn").addEventListener("click", loadAndRender);
    
    document.getElementById("predBtn").addEventListener("click", () => {
      alert("AI Prediction: Reduce 'Steamed Rice' production by 10% on Mondays.");
    });

    document.getElementById("exportBtn").addEventListener("click", () => {
      alert("CSV Report downloaded successfully.");
    });

    // Initial Load
    loadAndRender();

  </script>
</body>
</html>